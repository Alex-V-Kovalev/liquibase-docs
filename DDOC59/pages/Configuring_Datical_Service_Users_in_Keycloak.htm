<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
    <head><title></title>
    </head>
    <body>
        <h1>Configuring Datical Service Users in Keycloak</h1>
        <p />
        <div class="toc-macro client-side-toc-macro  conf-macro output-block">
        </div>
        <p>Configure Keycloak to map users from Active Directory/LDAP to Datical Users.&#160;</p>
        <p>You can also add users manually in Keycloak.&#160;</p>
        <p>When users log in to Datical Service, it authenticates them through Keycloak, which communicates with the Active Directory/LDAP services.&#160;</p>
        <h1 id="ConfiguringDaticalServiceUsersinKeycloak-AccessingKeycloak"><span style="color: rgb(33,33,33);">Accessing Keycloak</span>
        </h1>
        <ol>
            <li><span style="color: rgb(33,33,33);">Open Keycloak through one of the following methods:</span>
                <ul>
                    <li><span style="color: rgb(33,33,33);">Go to <strong>Admin&#160;&gt; Keycloak</strong> to open a login page for Keycloak.&#160;</span>
                    </li>
                    <li>
                        <p class="auto-cursor-target"><span style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);">Use the following URL in your browser:&#160;<br /></span></span></span>
                        </p>
                        <div class="preformatted panel conf-macro output-block" style="border-width: 1px;">
                            <div class="preformattedContent panelContent"><pre xml:space="preserve">https://&lt;datical-server&gt;/auth</pre>
                            </div>
                        </div>
                        <p class="auto-cursor-target"><span style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);"><br /><br /></span></span>
                        </p>
                    </li>
                </ul>
            </li>
            <li>Log in. The initial credentials are for user name <code>keycloak-admin</code>, password <code>datical</code>.&#160;<span style="color: rgb(33,33,33);"><em>You must change the password the first time you log in</em>.&#160;</span></li>
        </ol>
        <h1 id="ConfiguringDaticalServiceUsersinKeycloak-ConfiguringKeycloakforActiveDirectory/LDAPIntegration"><span style="color: rgb(33,33,33);">Configuring Keycloak for Active Directory/LDAP Integration</span>
        </h1>
        <ol>
            <li><span style="color: rgb(33,33,33);">Choose the <strong>Datical</strong> realm.&#160;</span>
            </li>
            <li><span style="color: rgb(33,33,33);">Open <strong>User Federatation</strong></span>
            </li>
            <li><span style="color: rgb(33,33,33);">Configure the listed configuration fields, then click <strong>Save</strong>. You may need to troubleshoot:</span>
                <ul>
                    <li><span style="color: rgb(33,33,33);"> Attribute mappers</span>
                    </li>
                    <li><span style="color: rgb(33,33,33);">Groups</span>
                    </li>
                    <li><span style="color: rgb(33,33,33);"><code>Bind DN/Bind Credentials</code>&#160;pair as noted below.&#160;</span>
                    </li>
                    <li><span style="color: rgb(33,33,33);">PKIX errors (certificate)</span>
                    </li>
                </ul>
            </li>
            <li><span style="color: rgb(33,33,33);">Click <strong>Synchronize All Users</strong> to see the list of users imported.&#160;</span>
            </li>
            <li><span style="color: rgb(33,33,33);">Verify the users imported. </span>
                <ol>
                    <li><span style="color: rgb(33,33,33);">Open a window for Datical Service</span>
                    </li>
                    <li><span style="color: rgb(33,33,33);">Choose <strong>Admin &gt; Users</strong>.</span>
                    </li>
                    <li><span style="color: rgb(33,33,33);">Inspect the list for incorrect or missing data.</span>
                    </li>
                </ol>
            </li>
        </ol>
        <h2 id="ConfiguringDaticalServiceUsersinKeycloak-ConfigurationFields"><span style="color: rgb(33,33,33);">Configuration Fields</span>
        </h2>
        <div class="table-wrap">
            <table class="wrapped confluenceTable">
                <colgroup>
                    <col />
                    <col />
                    <col />
                </colgroup>
                <tbody>
                    <tr>
                        <th class="confluenceTh">Field</th>
                        <th class="confluenceTh">Value</th>
                        <th class="confluenceTh">Notes</th>
                    </tr>
                    <tr>
                        <td class="confluenceTd">Edit Mode</td>
                        <td class="confluenceTd">READ_ONLY</td>
                        <td class="confluenceTd">
                            <br />
                        </td>
                    </tr>
                    <tr>
                        <td class="confluenceTd">Vendor</td>
                        <td class="confluenceTd">Active Directory</td>
                        <td class="confluenceTd">
                            <br />
                        </td>
                    </tr>
                    <tr>
                        <td class="confluenceTd">Username LDAP Attribute</td>
                        <td class="confluenceTd">Attribute that contains the user name.&#160;</td>
                        <td class="confluenceTd">
                            <p><span style="color: rgb(33,33,33);">Set this value to <strong>username</strong> and then configure mappers to designate the desired attribute to map to it.&#160; </span>
                            </p>
                            <p><span style="color: rgb(33,33,33);">See the "Attribute Mappers" section below for more information</span>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <td class="confluenceTd"><span style="color: rgb(33,33,33);">RDN LDAP Attribute</span>
                        </td>
                        <td class="confluenceTd">CN</td>
                        <td class="confluenceTd">
                            <br />
                        </td>
                    </tr>
                    <tr>
                        <td class="confluenceTd">Connection URL</td>
                        <td class="confluenceTd">URL for your service.&#160;</td>
                        <td class="confluenceTd">
                            <div class="content-wrapper">
                                <p><span style="color: rgb(33,33,33);">Usually of the following format:</span>
                                </p>
                                <div class="preformatted panel conf-macro output-block" style="border-width: 1px;">
                                    <div class="preformattedContent panelContent"><pre xml:space="preserve">&#160;ldaps://LDAP_HOST:636</pre>
                                    </div>
                                </div>
                                <p><span style="color: rgb(33,33,33);">Click <strong>Test Connection</strong> button to confirm</span>
                                </p>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="confluenceTd"><span style="color: rgb(33,33,33);">Users DN</span>
                        </td>
                        <td class="confluenceTd">Node containing users</td>
                        <td class="confluenceTd">
                            <div class="content-wrapper">
                                <p>Example:</p>
                                <div class="preformatted panel conf-macro output-block" style="border-width: 1px;">
                                    <div class="preformattedContent panelContent"><pre xml:space="preserve">CN=Users,DC=demo,DC=example,DC=com</pre>
                                    </div>
                                </div>
                                <p>This is not a group DN. You must specify a node that contains users.&#160;</p>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="confluenceTd"><span style="color: rgb(33,33,33);">Authentication type</span>
                        </td>
                        <td class="confluenceTd">simple</td>
                        <td class="confluenceTd">
                            <br />
                        </td>
                    </tr>
                    <tr>
                        <td class="confluenceTd"><span style="color: rgb(33,33,33);">Bind DN</span>
                        </td>
                        <td class="confluenceTd">DN of the administrative or service user that accesses the information to use.&#160;&#160;</td>
                        <td class="confluenceTd">
                            <div class="content-wrapper">
                                <p>Example:</p>
                                <div class="preformatted panel conf-macro output-block" style="border-width: 1px;">
                                    <div class="preformattedContent panelContent"><pre xml:space="preserve">CN=Administrator,CN=Users,DC=demo,DC=example,DC=com</pre>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="confluenceTd">Bind Credential</td>
                        <td class="confluenceTd">Password for the Bind DN user</td>
                        <td class="confluenceTd">
                            <p>Click Test Authentication to test the Bind DN/Bind Credential pair. Continue if it passes.&#160;</p>
                            <ul>
                                <li><span style="color: rgb(33,33,33);">If itfails, check the Keycloak log to find the reason</span>
                                </li>
                                <li><span style="color: rgb(33,33,33);">If the reason is <code>PKIX Path building failed</code>, see note below on PKIX</span>
                                </li>
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td class="confluenceTd"><span style="color: rgb(33,33,33);">Custom User LDAP Filter</span>
                        </td>
                        <td class="confluenceTd">Filter value</td>
                        <td class="confluenceTd">
                            <p><span style="color: rgb(33,33,33);">Used to filter the full list of users in the "Users DN" node to just the users you want to import into keycloak</span>
                            </p>
                            <ul>
                                <li><span style="color: rgb(33,33,33);">Can use a filter like (mail=*) to only include users with an email address (excludes service account users)</span>
                                </li>
                                <li><span style="color: rgb(33,33,33);">Can filter based on groups or anything else you need</span>
                                </li>
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="1" class="confluenceTd">Search Scope</td>
                        <td colspan="1" class="confluenceTd"><code>Subtree</code> or <code>One Level</code></td>
                        <td colspan="1" class="confluenceTd">
                            <p><span style="color: rgb(33,33,33);">If the node listed in "Users DN" contains nested nodes with users, select "Subtree". Otherwise select "one level"</span>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="1" class="confluenceTd">Other Attributes</td>
                        <td colspan="1" class="confluenceTd">Default or as you need.</td>
                        <td colspan="1" class="confluenceTd">
                            <br />
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <h2 id="ConfiguringDaticalServiceUsersinKeycloak-AttributeMappers"><span style="color: rgb(33,33,33);">Attribute Mappers</span>
        </h2>
        <p><span style="color: rgb(33,33,33);">By default, Keycloak does not copy all attributes it sees in the Active Directory object into the object it can import in. </span>
        </p>
        <p><span style="color: rgb(33,33,33);">Use the <strong>Mappers</strong> tab in the federation admin section to view mappings.&#160;</span>
        </p>
        <p><span style="color: rgb(33,33,33);">Default attribute mappings:</span>
        </p>
        <div class="table-wrap">
            <table class="wrapped confluenceTable">
                <colgroup>
                    <col />
                    <col />
                </colgroup>
                <tbody>
                    <tr>
                        <th class="confluenceTh">Active Directory</th>
                        <th class="confluenceTh">Keycloak</th>
                    </tr>
                    <tr>
                        <td class="confluenceTd">email</td>
                        <td class="confluenceTd">mail</td>
                    </tr>
                    <tr>
                        <td class="confluenceTd">cn</td>
                        <td class="confluenceTd">username</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <p>
            <br /><span style="color: rgb(33,33,33);">To use a value other than CN for logging in, modify the <strong>username</strong> LDAP Mapper.&#160; Set <strong>User Model Attribute</strong>&#160;to the name of the Active Directory field that contains the user name you want to use. containing the user name. </span>
        </p>
        <p><span style="color: rgb(33,33,33);">You can set it to whatever attribute is used for user logins in your environment. Examples:</span>
        </p>
        <ul>
            <li><code><span style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);">sAMAccountName</span></span></code>
            </li>
            <li><code><span style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);">email</span></span></code>
            </li>
        </ul>
        <h2 id="ConfiguringDaticalServiceUsersinKeycloak-GroupConfiguration"><span style="color: rgb(33,33,33);">Group Configuration</span>
        </h2>
        <p><span style="color: rgb(33,33,33);">By default, groups and group membership are not synchronized. </span>
        </p>
        <p><span style="color: rgb(33,33,33);">To enable it, add a mapper for <code>group-ldap-mapper</code> mapper.&#160;</span>
        </p>
        <p><span style="color: rgb(33,33,33);">Check that groups are imported correctly in <strong>Admin &gt; Groups</strong>.&#160;</span>
        </p>
        <h2 id="ConfiguringDaticalServiceUsersinKeycloak-Noteon&quot;PKIXPathBuildingFailed&quot;"><span style="color: rgb(33,33,33);">Note on "PKIX Path Building Failed"</span>
        </h2>
        <p><span style="color: rgb(33,33,33);">Active Directory servers may be secured using an organization-managed root certificate rather than a global certificate authority. The error is caused by Keycloak not recognizing the certificate.&#160;</span>
        </p>
        <p><span style="color: rgb(33,33,33);">To install the certificate into Keycloak, do the following:</span>
        </p>
        <div class="code panel pdl conf-macro output-block" style="border-width: 1px;">
            <div class="codeContent panelContent pdl"><pre class="syntaxhighlighter-pre" xml:space="preserve">datical-services-cli install-cert &lt;ad-host&gt;:&lt;port&gt;datical-services stop keycloak
datical-services up -d keycloak</pre>
            </div>
        </div>
        <p><span class="auto-cursor-target" style="color: rgb(33,33,33);">Log in to Keycloak again to test the <code>Bind DN/DN Credentials</code> pair.&#160;</span>
        </p>
        <h1 id="ConfiguringDaticalServiceUsersinKeycloak-AddingUsersManually"><span class="auto-cursor-target" style="color: rgb(33,33,33);">Adding Users Manually</span>
        </h1>
        <p><span class="auto-cursor-target" style="color: rgb(33,33,33);">It is preferable to integrate with Active Directory/LDAP to populate the users in Datical Service.</span>
        </p>
        <p><span class="auto-cursor-target" style="color: rgb(33,33,33);">In some cases you may want to add a user manually.&#160;</span>
        </p>
        <ol>
            <li><span class="auto-cursor-target" style="color: rgb(33,33,33);">Log on to Keycloak</span>
            </li>
            <li><span class="auto-cursor-target" style="color: rgb(33,33,33);">Click <strong>Users</strong></span>
            </li>
            <li><span class="auto-cursor-target" style="color: rgb(33,33,33);">Add users their initial passwords.&#160;&#160;</span>
            </li>
        </ol>
        <h1 id="ConfiguringDaticalServiceUsersinKeycloak-Troubleshooting"><span class="auto-cursor-target" style="color: rgb(33,33,33);">Troubleshooting</span>
        </h1>
        <p><span class="auto-cursor-target" style="color: rgb(33,33,33);">Use the following instructions to address problems with user synchronization. </span>
        </p>
        <h2 id="ConfiguringDaticalServiceUsersinKeycloak-MissingorIncorrectUserData"><span class="auto-cursor-target" style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);">Missing or Incorrect User Data</span></span>
        </h2>
        <p><span class="auto-cursor-target" style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);">If data is wrong or missing:</span></span>
        </p>
        <ol>
            <li><span class="auto-cursor-target" style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);">Log in to Keycloak as admin</span></span>
            </li>
            <li><span class="auto-cursor-target" style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);">In <strong>User Federation</strong>, modify the attribute mappings.</span></span>
            </li>
            <li>Click <strong>Synchronize All Users</strong></li>
            <li>In Datical Service, check the users in <strong>Admin &gt; Users</strong>.</li>
        </ol>
        <h2 id="ConfiguringDaticalServiceUsersinKeycloak-UnintendedUsers"><span class="auto-cursor-target" style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);">Unintended Users&#160;</span><br /></span>
        </h2>
        <p><span class="auto-cursor-target" style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);">When you check the list of users in Datical Service If there were users imported who should not have access, you can adjust the filtering. </span></span>
        </p>
        <ol>
            <li><span class="auto-cursor-target" style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);">Log in to Keycloak as admin</span></span>
            </li>
            <li><span class="auto-cursor-target" style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);">In <strong>User Federation</strong>, adjust the filter in <strong>Custom User LDAP Filter</strong>.&#160;</span></span>
            </li>
            <li>Click <strong>Synchronize All Users</strong></li>
            <li>In Datical Service, check the users in <strong>Admin &gt; Users</strong>.</li>
        </ol>
        <h2 id="ConfiguringDaticalServiceUsersinKeycloak-KeycloakIssues"><span class="auto-cursor-target" style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);">Keycloak Issues&#160;</span></span>
        </h2>
        <p><span class="auto-cursor-target" style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);">Monitor Keycloak messages:</span></span>
        </p>
        <ul>
            <li><span class="auto-cursor-target" style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);">Keycloak UI (not always detailed)</span></span>
            </li>
            <li><span class="auto-cursor-target" style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);">Keycloak service logs</span></span>
            </li>
        </ul>
        <h2 id="ConfiguringDaticalServiceUsersinKeycloak-KeycloakDocumentation"><span class="auto-cursor-target" style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);">Keycloak Documentation</span></span>
        </h2>
        <p><span class="auto-cursor-target" style="color: rgb(33,33,33);"><span style="color: rgb(33,33,33);">For more information on keycloak configuration, see&#160;&#160;</span><a class="external-link" href="http://www.keycloak.org/documentation.html" rel="nofollow">http://www.keycloak.org/documentation.html</a></span>
        </p>
        <p>
            <br />
        </p>
    </body>
</html>