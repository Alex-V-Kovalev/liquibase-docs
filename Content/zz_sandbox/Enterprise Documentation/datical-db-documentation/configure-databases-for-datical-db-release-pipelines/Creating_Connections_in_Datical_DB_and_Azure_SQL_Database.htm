<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
    <head><title></title>
    </head>
    <body>
        <h1>Creating Connections in Datical DB and Azure SQL Database</h1>
        <div class="toc-macro client-side-toc-macro  conf-macro output-block">
        </div>
        <p>There are the following types of connection and authentication (security) options available in Datical DB:</p><span class="confluence-embedded-file-wrapper image-left-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-left" width="340" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/thumbnails/1948745827/Connection%20Type.png?version=1&amp;modificationDate=1607435460876&amp;cacheVersion=1&amp;api=v2&amp;width=340&amp;height=378" srcset="https://datical-cs.atlassian.net/wiki/download/thumbnails/1948745827/Connection%20Type.png?version=1&amp;modificationDate=1607435460876&amp;cacheVersion=1&amp;api=v2&amp;width=680&amp;height=756 2x, https://datical-cs.atlassian.net/wiki/download/thumbnails/1948745827/Connection%20Type.png?version=1&amp;modificationDate=1607435460876&amp;cacheVersion=1&amp;api=v2&amp;width=340&amp;height=378 1x" /></span>
        <ul>
            <li>
                <p>Microsoft SQL Server with the SQL Authentication and Integrated Security</p>
            </li>
            <li>
                <p>Azure SQL Database and Azure SQL Managed Instance with:</p>
                <ul>
                    <li>
                        <p>SQL Authentication</p>
                    </li>
                    <li>
                        <p>Active Directory Integrated Authentication</p>
                    </li>
                    <li>
                        <p>Active Directory Password Authentication</p>
                    </li>
                    <li>
                        <p>Active Directory MSI Authentication</p>
                    </li>
                </ul>
            </li>
        </ul>
        <h2 id="CreatingConnectionsinDaticalDBandAzureSQLDatabase-SQLAuthentication">SQL Authentication</h2>
        <p>SQL Authentication refers to the authentication of a user when connecting to an Azure SQL Database and using username and password.</p>
        <div class="confluence-information-macro confluence-information-macro-information conf-macro output-block">
            <div class="confluence-information-macro-body">
                <p>If you are a server admin, you can authenticate to any database on the server or instance as the database owner and create additional SQL logins and users, which enable users to connect using username and password.</p>
            </div>
        </div>
        <p>To connect to an Azure SQL Database with the SQL Authentication (security) from Datical DB, enter the following information:</p>
        <ul>
            <li>
                <p>Username</p>
            </li>
            <li>
                <p>Password</p>
            </li>
            <li>
                <p>Hostname</p>
            </li>
            <li>
                <p>Port</p>
            </li>
            <li>
                <p>Database name</p>
            </li>
            <li>
                <p>Instance name</p>
            </li>
        </ul>
        <div class="confluence-information-macro confluence-information-macro-information conf-macro output-block">
            <div class="confluence-information-macro-body">
                <p>Add the IP address of the machine running <code>sqlcmd</code> to Azure Resource Group.</p>
            </div>
        </div>
        <h2 id="CreatingConnectionsinDaticalDBandAzureSQLDatabase-AzureActiveDirectoryAuthentication">Azure Active Directory Authentication</h2>
        <p>The Azure Active Directory authentication refers to the authentication of a user when connecting to an Azure SQL Database and using identities in Azure Active Directory.</p>
        <h3 id="CreatingConnectionsinDaticalDBandAzureSQLDatabase-Prerequisites">Prerequisites</h3>
        <p>To use the Azure Active Directory authentication mode, you need to:</p>
        <ul>
            <li>
                <p><a class="external-link" href="https://docs.microsoft.com/en-us/azure/azure-sql/database/authentication-aad-configure?tabs=azure-powershell" rel="nofollow">Configure Azure AD with Azure SQL Database</a>
                </p>
            </li>
            <li>
                <p>Install <a class="external-link" href="https://www.microsoft.com/en-us/download/details.aspx?id=48742" rel="nofollow">Active Directory Authentication Library</a> file</p>
            </li>
        </ul>
        <div class="confluence-information-macro confluence-information-macro-information conf-macro output-block">
            <div class="confluence-information-macro-body">
                <p>For more information, see <a class="external-link" href="https://docs.microsoft.com/en-us/azure/azure-sql/database/authentication-aad-overview" rel="nofollow">Use Azure Active Directory authentication</a>.</p>
            </div>
        </div>
        <h3 id="CreatingConnectionsinDaticalDBandAzureSQLDatabase-ActiveDirectoryIntegratedAuthentication">Active Directory Integrated Authentication</h3>
        <p>The Active Directory Integrated Authentication is a mechanism of connecting to an Azure SQL Database by using an integrated mode with Azure Active Directory.</p>
        <p>To use the Active Directory Integrated Security authentication option, follow these steps:</p>
        <ol>
            <li>
                <p>Log in with the admin user and create <code>USER [username] from EXTERNAL PROVIDER;</code> on the database you use. </p>
            </li>
            <li>
                <p>Add <code>ddladmin</code>, <code>datawriter</code>, and <code>datareader</code> roles for checking the status and Deploy Packager processes: <br /><code>EXEC sp_addrolemember 'db_ddladmin', 'datical_user';</code><br /><code>EXEC sp_addrolemember 'db_datawriter', 'datical_user';</code><br /><code>EXEC sp_addrolemember 'db_datareader', 'datical_user';</code></p>
            </li>
            <li>
                <p>Make sure that you federated the on-premise <a class="external-link" href="https://docs.microsoft.com/en-us/windows-server/identity/active-directory-federation-services" rel="nofollow">Active Directory Federation Services</a> (AD FS) with the Azure Active Directory in the cloud.</p>
            </li>
            <li>
                <p>Make the connection from a domain-joined machine that is federated with Azure Active Directory. You can access an Azure SQL Database without entering credentials when you're logged in to a domain-joined machine. Additionally, a database user representing your Azure Active Directory principal, or one of the groups to which the user belongs, needs to exist in the database and have the <code>CONNECT</code> permission.</p>
            </li>
            <li>
                <p>Install the <a class="external-link" href="https://docs.microsoft.com/en-us/sql/connect/oledb/download-oledb-driver-for-sql-server?view=sql-server-ver15" rel="nofollow">OLE DB Driver</a>. This msi installer should add <code>adal.dll</code> to <code>System32</code> and <code>Syswow64</code> folders.  </p>
            </li>
            <li>
                <p>Install the <a class="external-link" href="https://docs.microsoft.com/en-us/sql/connect/odbc/download-odbc-driver-for-sql-server?view=sql-server-ver15" rel="nofollow">ODBC Driver</a>.</p>
            </li>
            <li>
                <p>Ensure that the SQL Server JDBC Driver Authentication Library is in <code>\Windows\System32</code>. The file is named <code>mssql-jdbc_auth-&lt;version&gt;.x64.dll</code> where <code>&lt;version&gt;</code> is a version number for the file.</p>
                <ol>
                    <li>
                        <p>If the <code>mssql-jdbc_auth-&lt;version&gt;.x64.dll</code> library is not already in <code>\Windows\System32</code>, it can be extracted from the following file (if you have installed the SQL Server JDBC Driver for Liquibase Enterprise/Datical):  <code>&lt;datical-install&gt;\plugins\com.datical.db.drivers.mssql_&lt;version&gt;.jar</code> </p>
                    </li>
                    <li>
                        <p>Using an archive utility, open or extract the <code>com.datical.db.drivers.mssql_&lt;version&gt;.jar</code> file to access its contents.</p>
                    </li>
                    <li>
                        <p>The DLL is located in the following archive location: <code>com.datical.db.drivers.mssql_1.0.24.jar\auth\x64\mssql-jdbc_auth-&lt;version&gt;.x64.dll</code></p>
                    </li>
                    <li>
                        <p>Put the <code>mssql-jdbc_auth-&lt;version&gt;.x64.dll</code> file in <code>\Windows\System32</code></p>
                    </li>
                </ol>
            </li>
            <li>
                <p>Make sure <code>sqlcmd</code> (version 13.1 or higher) is installed and on your PATH. To install <code>sqlcmd</code>, go to the <a class="external-link" href="https://docs.microsoft.com/en-us/sql/tools/sqlcmd-utility?view=sql-server-ver15" rel="nofollow">sqlcmd Utility</a> page.</p>
            </li>
        </ol>
        <div class="confluence-information-macro confluence-information-macro-information conf-macro output-block">
            <div class="confluence-information-macro-body">
                <p>For more information about the configuration of the <code>ActiveDirectoryIntegrated</code> authentication, see <a class="external-link" href="https://docs.microsoft.com/en-us/sql/connect/jdbc/connecting-using-azure-active-directory-authentication?view=sql-server-ver15#connecting-using-activedirectoryintegrated-authentication-mode" rel="nofollow">Connecting using ActiveDirectoryIntegrated authentication</a>.</p>
            </div>
        </div>
        <p>To create a connection with the Active Directory Integrated mode in the Liquibase Enterprise/Datical DB GUI, select the following:</p>
        <ul>
            <li>
                <p><strong>Connection Type </strong>- Azure SQL Database</p>
            </li>
            <li>
                <p><strong>Security </strong>– Active Directory Integrated Security</p>
            </li>
        </ul>
        <p>Also, enter your hostname, port, application name, database name, and instance name.</p>
        <p>You can test the connection either by using the <strong>Test Connection</strong> button in the GUI or by running<br /><code>hammer testConnect &lt;dbDef&gt;</code> from the command line.  </p>
        <div class="confluence-information-macro confluence-information-macro-information conf-macro output-block">
            <div class="confluence-information-macro-body">
                <p>If you have any issues, refer to <a href="Troubleshooting_Issues_with_Active_Directory_Authentication_and_Azure_SQL_Database.htm">Troubleshooting Issues with Active Directory Authentication and Azure SQL Database</a>.</p>
            </div>
        </div>
        <h3 id="CreatingConnectionsinDaticalDBandAzureSQLDatabase-ActiveDirectoryPasswordAuthentication">Active Directory Password Authentication</h3>
        <p>As the Azure Active Directory Password Authentication is a mechanism of connecting to an Azure SQL Database by using identities in Azure Active Directory, you can connect to applications by using an Azure Active Directory user name and password.</p>
        <p>To connect using the Active Directory Password authentication, follow these steps:</p>
        <ol>
            <li>
                <p>Log in with the admin user and create <code>USER [username] from EXTERNAL PROVIDER;</code> on the database you use. </p>
            </li>
            <li>
                <p>Add <code>ddladmin</code>, <code>datawriter</code>, and <code>datareader</code> roles for checking the status and Deploy Packager processes: <br /><code>EXEC sp_addrolemember 'db_ddladmin', 'datical_user';</code><br /><code>EXEC sp_addrolemember 'db_datawriter', 'datical_user';</code><br /><code>EXEC sp_addrolemember 'db_datareader', 'datical_user';</code></p>
            </li>
            <li>
                <p>Install the SQL Server JDBC Driver Authentication Library - <code>mssql-jdbc_auth-&lt;version&gt;-&lt;arch&gt;.dll</code> file on your machine. The file is located in the <code>&lt;datical-install&gt;\DaticalDB\plugins\ directory</code>.</p>
                <ol>
                    <li>
                        <p>Copy&#160;<code>com.datical.db.drivers.mssql_1.x.x.jar</code> to a temporary directory and unzip it (<code>&lt;unzip directory&gt;</code>).&#160;</p>
                    </li>
                    <li>
                        <p>On Windows systems you can:</p>
                        <p>o Use &lt;java-install-path&gt;\JAVA\jar.exe xf &lt;name&gt;.jar</p>
                        <p>o Change the extension of the file from <code>.jar</code> to <code>.zip</code>&#160;and then unzip it.</p>
                    </li>
                    <li>
                        <p>Go to <code>&lt;unzip directory&gt;\auth\</code>, then go to the folder for your version of the Java Virtual Machine (JVM).&#160;</p>
                    </li>
                </ol>
            </li>
            <li>
                <p>Put the <code>mssql-jdbc_auth-&lt;version&gt;-&lt;arch&gt;.dll</code> file in <code>\Windows\System32</code>. There are 32-bit and 64-bit versions of the <code>.dll</code> file included with the Microsoft SQL Server JDBC driver. For example: <code>mssql-jdbc_auth-8.4.1.x64.dll</code>.</p>
            </li>
        </ol>
        <div class="confluence-information-macro confluence-information-macro-information conf-macro output-block">
            <div class="confluence-information-macro-body">
                <p>For more information about the configuration of the <code>ActiveDirectoryPassword</code> authentication, see <a class="external-link" href="https://docs.microsoft.com/en-us/sql/connect/jdbc/connecting-using-azure-active-directory-authentication?view=sql-server-ver15#connecting-using-activedirectorypassword-authentication-mode" rel="nofollow">Connecting using ActiveDirectoryPassword authentication mode</a>.</p>
            </div>
        </div>
        <p>To create a connection with the Active Directory Password mode in Datical DB, select the following:</p>
        <ul>
            <li>
                <p><strong>Connection Type </strong>-Azure SQL Database</p>
            </li>
            <li>
                <p><strong>Security </strong>-Active Directory Password Authentication</p>
            </li>
        </ul>
        <p>Also, enter your hostname, port, application name, database name, instance name, username, and password.</p>
        <h3 id="CreatingConnectionsinDaticalDBandAzureSQLDatabase-ActiveDirectoryMSIAuthentication">Active Directory MSI Authentication</h3>
        <p>You can use the Active Directory MSI Authentication for connection from inside of an Azure Resource with the <code>Identity</code> feature.</p>
        <p>To use the Active Directory MSI Authentication, you need a contained database user representing your Azure Resource's System Assigned Managed Identity or User Assigned Managed Identity, or one of the groups your Managed Identity belongs to, which must exist in the target database and have the <code>CONNECT</code> permission.</p>
        <p>Optionally, to acquire the <code>accessToken</code> for establishing the connection, you can specify <code>msiClientId</code> in the <code>Connection</code> or <code>DataSource</code> properties along with the Active Directory MSI Authentication mode, which must include the <code>Client ID</code> of a <code>Managed Identity</code>.</p>
        <div class="panel conf-macro output-block" style="background-color: #EAE6FF;border-color: #998DD9;border-width: 1px;">
            <div class="panelContent" style="background-color: #EAE6FF;">
                <p>To get <code>msiClientId</code>, create Managed Identity with the resource group. Check <a class="external-link" href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/tutorial-windows-vm-access-sql" rel="nofollow">https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/tutorial-windows-vm-access-sql</a> and <a class="external-link" href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm#system-assigned-managed-identity" rel="nofollow">https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm#system-assigned-managed-identity</a> for more details about managed identities.</p>
            </div>
        </div>
        <div class="confluence-information-macro confluence-information-macro-information conf-macro output-block">
            <div class="confluence-information-macro-body">
                <p>For more information about the configuration of the <code>ActiveDirectoryMSI</code> authentication, see <a class="external-link" href="https://docs.microsoft.com/en-us/sql/connect/jdbc/connecting-using-azure-active-directory-authentication?view=sql-server-ver15#connecting-using-activedirectorymsi-authentication-mode" rel="nofollow">Connecting using ActiveDirectoryMSI authentication mode</a>.</p>
            </div>
        </div>
        <p>To create a connection with the Active Directory MSI mode in the Datical DB GUI, go to the Edit Connection screen. Select the following:</p>
        <ul>
            <li>
                <p><strong>Connection Type </strong>-Azure SQL Database</p>
            </li>
            <li>
                <p><strong>Security </strong>-Active Directory MSI Authentication</p>
            </li>
            <li>
                <p>Also enter your hostname, port, application name, database name, instance name, and MSI Client ID.</p>
            </li>
        </ul>
        <p>Then define properties in your driver properties file:</p>
        <ul>
            <li>
                <p>Go to your Liquibase Enterprise/Datical installation directory (such as C:\Apps\DaticalDB_7.13).</p>
            </li>
            <li>
                <p>Edit the file called mssql_driver.properties.</p>
            </li>
            <li>
                <p>Add these two lines to your mssql_driver.properties file:</p>
            </li>
        </ul>
        <blockquote>
            <p>trustServerCertificate=true</p>
            <p>hostNameInCertificate=*.azure.&lt;domain&gt;</p>
        </blockquote>
        <p>(Replace &lt;domain&gt; with your actual domain name. For example: hostNameInCertificate=*.azure.acme.com.)</p>
        <div class="confluence-information-macro confluence-information-macro-note conf-macro output-block">
            <div class="confluence-information-macro-body">
                <p>The <code>appdba:sqlcmd</code> change type is not supported when using MSI Authentication:  </p>
                <ul>
                    <li>
                        <p>In the GUI do not use the change set type called “Execute with sqlcmd for Microsoft SQL Server &amp; Azure SQL Databases”. Please use the “Execute a SQL script file using JDBC” change set type with MSI Authentication instead.</p>
                    </li>
                    <li>
                        <p>In Packager do not use the <code>DDL_DIRECT</code>,<code>DATA_DML</code>, <code>DIRECT</code>, or <code>CONVERT</code> package methods which are the defaults for the “ddl_direct”, “data_dml”, “ddl”, and “sql_direct” folders. Please use only the <code>SQLFILE</code> and <code>STOREDLOGIC</code>package methods with MSI Authentication instead. Read more about setting packageMethod in metadata.properties here: </p>
                        <ul>
                            <li>
                                <p><a href="../package-sql-scripts-for-deployment/place-files-in-the-scm-repository/Flexible_Folder_Names.htm">Flexible Folder Names</a> </p>
                            </li>
                            <li>
                                <p><a href="../package-sql-scripts-for-deployment/configure-package-for-projects/Using_the_metadata_properties_file.htm">Using the metadata.properties file</a> </p>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
        <p>
        </p>
        <p />
    </body>
</html>