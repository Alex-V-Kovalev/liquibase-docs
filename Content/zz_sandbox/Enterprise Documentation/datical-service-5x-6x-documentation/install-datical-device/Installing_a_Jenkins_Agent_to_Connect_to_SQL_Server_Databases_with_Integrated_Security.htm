<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
    <head><title></title>
    </head>
    <body>
        <h1>Installing a Jenkins Agent to Connect to SQL Server Databases with Integrated Security</h1>
        <p />
        <div class="toc-macro client-side-toc-macro  conf-macro output-block">
        </div>
        <p>This guide shows you how to set up the Datical Jenkins Agent. It is needed to perform operations on a Microsoft SQL Server database running with with&#160;<strong>integrated security</strong>. In Jenkins documentation, this functionality is called&#160;<em>Jenkins slave</em>.</p>
        <h1 id="InstallingaJenkinsAgenttoConnecttoSQLServerDatabaseswithIntegratedSecurity-Scenario">Scenario</h1>
        <ul>
            <li>Datical Service is installed on a Linux host or VM.&#160; It runs Datical operations through a Jenkins instance on a docker image.&#160; The Jenkins instance runs Datical hammer commands on a Datical DB instance on the same image.&#160;</li>
            <li>A Datical project requires managed databases on SQL Server:&#160; A project contains a step that requires a connection to SQL Server database running on Windows with Integrated Security (Windows authentication).&#160;</li>
        </ul>
        <h2 id="InstallingaJenkinsAgenttoConnecttoSQLServerDatabaseswithIntegratedSecurity-Issue">Issue</h2>
        <p>Integrated security requires that all operations run with authorization through a Windows identity.&#160; Datical Service does not have such an identity.&#160;</p>
        <h2 id="InstallingaJenkinsAgenttoConnecttoSQLServerDatabaseswithIntegratedSecurity-Solution">Solution</h2>
        <p>Set up a <strong>Jenkins agent</strong> on a Windows host that has access to the SQL Server database. The agent satisfies the requirements of:</p>
        <ul>
            <li>Accepting and running Datical commands sent from Jenkins in Datical Service.&#160;</li>
            <li>Using a Windows identity for authentication and authorization to perform operations on SQL Server.&#160;Operations are Datical hammer commands run in Datical DB.&#160;You install Datical DB on the Windows host for the agent to use.&#160;</li>
        </ul>
        <p>Operations are Datical hammer commands run in Datical DB.&#160;You install both Datical DB and the Jenkins agent on the Windows host.&#160;</p>
        <p>The agent receives and runs commands sent from the Jenkins master instance that runs in Datical Service.</p>
        <h2 id="InstallingaJenkinsAgenttoConnecttoSQLServerDatabaseswithIntegratedSecurity-Background">Background</h2>
        <p>The solution uses a known methodology within Jenkins (Jenkins agent or slave). For more information, see the following Jenkins resources</p>
        <ul>
            <li><a class="external-link" href="https://wiki.jenkins.io/display/JENKINS/Step+by+step+guide+to+set+up+master+and+slave+machines+on+Windows" rel="nofollow">https://wiki.jenkins.io/display/JENKINS/Step+by+step+guide+to+set+up+master+and+slave+machines+on+Windows</a>
            </li>
            <li><a class="external-link" href="https://wiki.jenkins.io/display/JENKINS/Distributed+builds" rel="nofollow">https://wiki.jenkins.io/display/JENKINS/Distributed+builds</a>
            </li>
        </ul>
        <p>All of these steps are to be performed on the Windows box or VM where you wish to install the Jenkins agent. This agent runs commands sent from the Jenkins master in the Datical Service.</p>
        <h1 id="InstallingaJenkinsAgenttoConnecttoSQLServerDatabaseswithIntegratedSecurity-SetUptheWindowsHostfortheJenkinsAgent">Set Up the Windows Host for the Jenkins Agent</h1>
        <p>Install and set up Datical DB on a host in the Windows domain where SQL Server is installed.&#160;</p>
        <ol>
            <li>
                <p>Install the latest version of Datical DB. It must be version 5.0 or later.&#160;</p>
                <ul>
                    <li>See&#160;<a href="../../../../../DDOC59/pages/Installing_Datical_DB_Components.htm">Installing Datical DB Components</a> for instructions.&#160;</li>
                    <li>Include the database driver for the SQL Server database.</li>
                    <li>Include the SCM client for your repository (Git, SVN, TFS).&#160;</li>
                </ul>
            </li>
            <li>
                <p>Check that the PATH system environment variable contains the following entries. You can test that both it worked, and you have a valid license installed by running "hammer show version".&#160;<br /><br /></p>
                <div class="code panel pdl conf-macro output-block" style="border-width: 1px;">
                    <div class="codeContent panelContent pdl"><pre class="syntaxhighlighter-pre" xml:space="preserve">C:\Users\Admin\DaticalDB\repl
C:\Users\Admin\DaticalDB\repl\scripts
</pre>
                    </div>
                </div>
            </li>
            <li>
                <p class="auto-cursor-target">Check the license.&#160;<br /><br /></p>
                <div class="code panel pdl conf-macro output-block" style="border-width: 1px;">
                    <div class="codeContent panelContent pdl"><pre class="syntaxhighlighter-pre" xml:space="preserve">hammer show license</pre>
                    </div>
                </div>
            </li>
            <li>
                <p>Add system environment variable <code>DATICAL_SERVER</code> to the <code>address:port</code> of the Datical server. For example:</p>
                <div class="code panel pdl conf-macro output-block" style="border-width: 1px;">
                    <div class="codeContent panelContent pdl"><pre class="syntaxhighlighter-pre" xml:space="preserve">datical-server.my-network.net:443
</pre>
                    </div>
                </div>
            </li>
            <li>
                <p>Install Java 8 and add its installation location to the PATH.</p>
                <ul>
                    <li>
                        <p>After installation, open a command shell and run&#160; <code>java -version</code>.&#160; It should show Java 8.&#160; (<code>java version 1.8.x_nnn</code>)</p>
                    </li>
                    <li>This installation of Java is used by the Jenkins agent and is separate from the one installed by Datical for its own use. The Datical installation of Java is shown by the <code>JAVA_HOME</code> system environment variable.</li>
                </ul>
            </li>
            <li>Identify or create the user on Windows that the Jenkins agent will use.&#160; It should be managed as a service account.</li>
        </ol>
        <h1 id="InstallingaJenkinsAgenttoConnecttoSQLServerDatabaseswithIntegratedSecurity-ConfiguretheDaticalserver">Configure the Datical server</h1>
        <p style="text-align: left;">To open the necessary network ports so Datical server starts listening for connection requests from an external Jenkins agent:</p>
        <ol>
            <li>Make sure that the datical-server host has the ports <span style="color: rgb(23,43,77);">30500 and 30580&#160;</span>open, as do any firewalls in between, since that is what the Jenkins agent will communicate through.</li>
            <li>Run this command on the Datical server:</li>
        </ol>
        <div class="code panel pdl conf-macro output-block" style="border-width: 1px;">
            <div class="codeContent panelContent pdl"><pre class="syntaxhighlighter-pre" xml:space="preserve">datical-control internal-client open-agent-port</pre>
            </div>
        </div>
        <h1 id="InstallingaJenkinsAgenttoConnecttoSQLServerDatabaseswithIntegratedSecurity-CreatetheJenkinsAgent">Create the Jenkins Agent</h1>
        <ol>
            <li>On the Windows system, in a browser, go to&#160;<code><code>&lt;datical-host&gt;:30580/jenkins/</code></code><ol><li>For&#160;<code>&lt;datical-host&gt;</code>, use the hostname that you set for the environment variable <code>DATICAL_SERVER</code>.</li></ol></li>
            <li>Navigate to the link "winagent"</li>
            <li>Click the orange button "Launch"</li>
            <li>The browser will download a file with the extension "jnlp". Launch that file by double-clicking the downloaded file in the browser.</li>
            <li>Review the dialog boxes requesting permissions, and accept if appropriate.</li>
            <li>A small Java window with the Jenkins graphic should now open and report status "Connected" within it. Closing this window will stop the agent.</li>
        </ol>
        <h1 id="InstallingaJenkinsAgenttoConnecttoSQLServerDatabaseswithIntegratedSecurity-CreateaProject">Create a Project&#160;</h1>
        <p>You can now create projects in Datical Service that have connections to the SQL Server database with Integrated Security. A connection to a database is required for each step in a pipeline.</p>
        <ol>
            <li>Create project</li>
            <li>Create pipeline</li>
            <li>Create step</li>
            <li>In the step, click Create Connection.&#160;</li>
            <li>For the user, enter a the fully qualified user name. (<code>&lt;windowsDomain&gt;/&lt;windowsUser&gt;</code>). Example: <code>MyWindowsDomain/JenkinsAgentServiceUser</code>.</li>
            <li>Enter the password for that windows user on that windows domain</li>
            <li><strong>Make sure the Integrated Security Checkbox is checked!</strong> Checking it also disables the <strong>Test Connection</strong> button. Datical currently cannot make a connection attempt through the agent.</li>
        </ol>
        <p>
            <br />
        </p>
    </body>
</html>