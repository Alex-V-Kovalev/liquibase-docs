<?xml version="1.0" encoding="utf-8"?>
<html>
    <head><title></title>
    </head>
    <body>
        <h1>Migrate v5.3 and Update on Existing Host</h1>
        <p />
        <div class="toc-macro client-side-toc-macro  conf-macro output-block"></div>
        <p>Use these instructions to update to the current version from a previous installed instance of Datical Service 5.3. These instructions are for both physical servers and servers in a VM.&#160;</p>
        <p>During the process all system data is migrated using the following process</p>
        <ol>
            <li>Back up up existing data from your current Datical Service v5.3 instance.</li>
            <li>Install a new Datical Service (v5.6.1 or later) instance on the same host as your current Datical Service instance.</li>
            <li>Restore the backed-up data to the new Datical Service instance.&#160;</li>
            <li>Validate the new Datical Service instance to be sure that the data was migrated correctly.&#160;</li>
            <li>Remove the old Datical Service v5.3 instance.&#160;</li>
        </ol>
        <div class="confluence-information-macro confluence-information-macro-information conf-macro output-block">
            <p class="title">Note</p>
            <div class="confluence-information-macro-body">
                <p>All users are migrated. The default users on the newly installed Datical Service instance are not kept.&#160;</p>
            </div>
        </div>
        <h1 id="Migratev5.3andUpdateonExistingHost-0.Prerequisites">0. Prerequisites</h1>
        <ul>
            <li>Check your existing host to make sure it has enough disk space. There needs to be enough space for the original system plus a duplicate of it during the migration process.&#160;</li>
            <li>Back up the existing Datical Service (snapshot your VM). The upgrade process cannot be reversed.&#160;</li>
            <li>Check that the administrative user and password are current for the application database in the current v5.3 installation<br /><ul><li>Normally in v5.3 you maintain the application database credentials in <strong>Admin &gt; System Settings</strong>.</li><li>If the database password was changed <em>outside</em> of Datical Service (directly in PostgreSQL) and the Datical Service credentials were not changed to match them, then Datical Service does not have those credentials.&#160;</li><li>If the credentials are incorrect, the migration halts with an error. Go to&#160;<strong>Admin &gt; System Settings</strong> to enter the correct credentials before trying again.&#160;</li><li>See v5.3&#160;<a href="https://datical-cs.atlassian.net/wiki/spaces/DSV53/pages/724205853">/wiki/spaces/DSV53/pages/724205853</a>.&#160;</li></ul></li>
            <li>Datical Service is unavailable during the migration process.&#160;Plan to do an update during a scheduled outage</li>
        </ul>
        <h1 id="Migratev5.3andUpdateonExistingHost-1.DownloadBackupScripts">1. Download Backup Scripts</h1>
        <p>Download the following backup scripts from Artifactory. You are prompted for Artifactory credentials.&#160;</p>
        <ol>
            <li><a class="external-link" href="http://artifactory.datical.net/artifactory/webapp/#/artifacts/browse/simple/General/datical-files-public/dmcmigration-backup.jar" rel="nofollow">http://artifactory.datical.net/artifactory/webapp/#/artifacts/browse/simple/General/datical-files-public/dmcmigration-backup.jar</a>
            </li>
            <li><a class="external-link" href="http://artifactory.datical.net/artifactory/webapp/#/artifacts/browse/simple/General/datical-files-public/dmcmigration-backup.sh" rel="nofollow">http://artifactory.datical.net/artifactory/webapp/#/artifacts/browse/simple/General/datical-files-public/dmcmigration-backup-no-destroy.sh</a>
            </li>
            <li><a class="external-link" href="http://artifactory.datical.net/artifactory/webapp/#/artifacts/browse/simple/General/datical-files-public/dmcmigration-backup.sh" rel="nofollow">http://artifactory.datical.net/artifactory/webapp/#/artifacts/browse/simple/General/datical-files-public/dmcmigration-cleanup.sh</a>
            </li>
        </ol>
        <h1 id="Migratev5.3andUpdateonExistingHost-2.PlaceBackupandCleanupScriptsonCurrentDaticalServiceHost">2. Place Backup and Cleanup Scripts on Current Datical Service Host</h1>
        <p>Put the downloaded backup scripts in a directory on the current Datical Service host. The examples use scp to place the files in /opt/datical.&#160;</p>
        <div class="code panel pdl conf-macro output-block" style="border-width: 1px;">
            <div class="codeContent panelContent pdl"><pre class="syntaxhighlighter-pre" xml:space="preserve">scp dmcmigration-backup.jar datical@&lt;datical_service_host&gt;:/opt/datical
scp dmcmigration-backup-no-destroy.sh datical@&lt;datical_service_host&gt;:/opt/datical
scp dmcmigration-cleanup.sh datical@&lt;datical_service_host&gt;:/opt/datical</pre>
            </div>
        </div>
        <h1 id="Migratev5.3andUpdateonExistingHost-3.BackUptheCurrentSystem">3. Back Up the Current System</h1>
        <p>Run the migration scripts. They create the output in the same directory where the script is run.&#160;</p>
        <p>
            <br />
        </p>
        <div class="code panel pdl conf-macro output-block" style="border-width: 1px;">
            <div class="codeContent panelContent pdl"><pre class="syntaxhighlighter-pre" xml:space="preserve">$ cd /opt/datical
$ sudo sh dmcmigration-backup-no-destroy.sh applicationdbexternal=false auditdbexternal=false
applicationdbexternal is 'true' if application database is external
auditdbexternal is 'true' if audit database is external</pre>
            </div>
        </div>
        <h1 id="Migratev5.3andUpdateonExistingHost-4.RemovetheOriginalInstallation">4. Remove the Original Installation&#160;</h1>
        <div class="confluence-information-macro confluence-information-macro-information conf-macro output-block">
            <p class="title">Note</p>
            <div class="confluence-information-macro-body">
                <p>Confirm that the data has been restored correctly to the new installation before removing the original system.&#160;</p>
            </div>
        </div>
        <p>To remove the original installation, run the cleanup script on the original host.&#160;</p>
        <div class="code panel pdl conf-macro output-block" style="border-width: 1px;">
            <div class="codeContent panelContent pdl"><pre class="syntaxhighlighter-pre" xml:space="preserve">$ cd /opt/datical
$ sudo sh dmcmigration-cleanup.sh</pre>
            </div>
        </div>
        <h1 id="Migratev5.3andUpdateonExistingHost-5.PerformaNewInstallationofDaticalService">5. Perform a New Installation of Datical Service</h1>
        <p><strong>Internal-client Usage in 5.3:</strong>
        </p>
        <ul>
            <li><strong>NO</strong>- Edit the file&#160;<strong>/opt/datical/dmcmigration/consulkeyvalues.txt&#160;</strong>and modify the entry at the end of the file to "<strong>include_internal_client:false</strong>"</li>
            <li><strong>YES</strong> - If internal-client is used in 5.3, then ensure the <strong>new installation of Datical Service has internal-client enabled</strong>.</li>
        </ul>
        <p>Follow the instructions here:&#160;<a href="../../../../DDOC59/pages/Installing_Datical_Service_on_a_Server_or_VM.htm" rel="nofollow">Installing Datical Service on a Server or VM</a>.</p>
        <h1 id="Migratev5.3andUpdateonExistingHost-6.RestoretheBackedUpSystemtotheNewInstallation">6. Restore the Backed Up System to the New Installation</h1>
        <p>Before you perform the below step, make sure all services are up and running&#160;</p>
        <p>Perform the following step on the running installation of Datical Service.&#160;</p>
        <p>Run the migration script on the Datical Server host.&#160;</p>
        <div class="code panel pdl conf-macro output-block" style="border-width: 1px;">
            <div class="codeContent panelContent pdl"><pre class="syntaxhighlighter-pre" xml:space="preserve">$ cd /opt/datical
$ sudo datical-control migrate-dmc --applicationdbexternal=false --auditdbexternal=false
applicationdbexternal is 'true' if application database is external
auditdbexternal is 'true' if audit database is external</pre>
            </div>
        </div>
    </body>
</html>