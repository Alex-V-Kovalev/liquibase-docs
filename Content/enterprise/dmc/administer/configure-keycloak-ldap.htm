<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
    <head>
    </head>
    <body>
        <h1>Configuring Keycloak for active directory and LDAP integration</h1>
        <p style="text-align: center;"><iframe width="560" height="315" src="https://www.youtube.com/embed/HYZNuz-4m4E" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="true"></iframe>
        </p>
        <p>To create new users in the <MadCap:variable name="General.DMCProductShortName"></MadCap:variable>:</p>
        <ol>
            <li>Navigate to the <b>Keycloak</b> tab and log into Keycloak with your username and password.</li>
            <li>In <b>User Federation</b> tab, select <b>ldap</b> from the <b>Add provider</b> dropdown.</li>
            <p>
                <img src="../Z_Resources/Images/Assets/Screenshots/administer/keycloak-ldap.png" />
            </p>
            <li>Provide the required LDAP configuration details (see section below for more information).</li>
            <li>Select <b>Synchronize All Users</b> to see the list of users imported.</li>
            <li>Check your users in the <MadCap:variable name="General.DMCProductShortName" /> in <b>User Settings</b> to verify they were imported correctly.</li>
        </ol>
        <h2>Required LDAP configuration fields</h2>
        <p>In the <b>Add user federation provider</b> section, add the following required settings:</p>
        <table>
            <col />
            <col />
            <col />
            <thead>
                <tr>
                    <th>Field</th>
                    <th>Value</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Edit Mode</td>
                    <td>READ_ONLY</td>
                    <td>&#160;</td>
                </tr>
                <tr>
                    <td>Vendor</td>
                    <td>Active Directory</td>
                    <td>The LDAP provider you are using.</td>
                </tr>
                <tr>
                    <td>Username LDAP Attribute</td>
                    <td>Attribute that contains the user name.</td>
                    <td>
                        <p>Set this value to <u>username</u> and then configure mappers to designate the desired attribute to map to it. 

</p>
                        <p>See the <b>Attribute Mappers</b> section below for more information.</p>
                    </td>
                </tr>
                <tr>
                    <td>RDN LDAP Attribute</td>
                    <td>CN</td>
                    <td>&#160;</td>
                </tr>
                <tr>
                    <td>Connection URL</td>
                    <td>The connection URL to your LDAP server.</td>
                    <td>
                        <p>	

Usually of the following format: <code>ldaps://LDAP_HOST:636</code><![CDATA[
]]></p>
                        <p>Select the <b>Test Connection</b> button to confirm.</p>
                    </td>
                </tr>
                <tr>
                    <td>Users DN</td>
                    <td>The full DN of the LDAP tree where your users are located.</td>
                    <td>
                        <p>This DN is the LDAP user parent. </p>
                        <p class="example" MadCap:autonum="&lt;b&gt;Example: &lt;/b&gt;">It would be <code>CN=users,DC=example,DC=com</code> assuming that your typical user has a DN like: <code>uid=john,ou=users,dc=example,dc=com</code></p>
                        <p>This is not a group DN. You must specify a node that contains users.</p>
                    </td>
                </tr>
                <tr>
                    <td>Authentication type</td>
                    <td>Simple</td>
                    <td>&#160;</td>
                </tr>
                <tr>
                    <td>Bind DN</td>
                    <td>DN of the administrative or service user that accesses the information to use.</td>
                    <td>
                        <p class="example" MadCap:autonum="&lt;b&gt;Example: &lt;/b&gt;"><code>CN=Administrator,CN=Users,DC=demo,DC=example,DC=com</code>
                        </p>
                    </td>
                </tr>
                <tr>
                    <td>Bind Credential</td>
                    <td>--</td>
                    <td>
                        <p>Select <b>Test Authentication</b> to test the Bind DN/Bind Credential pair. Continue if it passes. 

    </p>
                        <ul>
                            <li>If it fails, check the Keycloak log to find the reason. Run the following command: <code>datical-control logs keycloak</code></li>
                            <li>If the reason is PKIX Path building failed, see note below on PKIX</li>
                        </ul>
                    </td>
                </tr>
                <tr>
                    <td>Custom User LDAP Filter</td>
                    <td>Filter value</td>
                    <td>
                        <p>Used to filter the full list of users in the "Users DN" node to just the users you want to import into keycloak.

    </p>
                        <ul>
                            <li>Can use a filter like (mail=*) to only include users with an email address (excludes service account users)
    </li>
                            <li>Can filter based on groups or anything else you need</li>
                        </ul>
                    </td>
                </tr>
                <tr>
                    <td>Search Scope</td>
                    <td>Subtree or One Level</td>
                    <td>If the node listed in "Users DN" contains nested nodes with users, select "Subtree". Otherwise select "one level".</td>
                </tr>
                <tr>
                    <td>Other Attributes</td>
                    <td>Default or as you need</td>
                    <td>&#160;</td>
                </tr>
            </tbody>
        </table>
        <p class="note" MadCap:autonum="&lt;b&gt;Note: &lt;/b&gt;">All other fields in the <b>Add user federation provider</b> section may need values changed depending on your particular ADD configuration.</p>
        <h2>Attribute mappers</h2>
        <p>By default, Keycloak does not copy all attributes it sees in the Active Directory the Mappers tab in the user federation admin section to view mappings.</p>
        <p>Default attribute mappings:</p>
        <ul>
            <li>email	mail</li>
            <li>cn	username</li>
        </ul>
        <p>To use a value other than CN for logging in, modify the username LDAP Mapper.  Set User Model Attribute to the name of the Active Directory field that contains the user name you want to use.</p>
        <p>You can set it to whatever attribute is used for user logins in your environment. Examples:</p>
        <ul>
            <li>sAMAccountName</li>
            <li>email</li>
        </ul>
        <h2>Note on "PKIX Path Building Failed"</h2>
        <p>Active Directory servers may be secured using an organization-managed root certificate rather than a global certificate authority. The error is caused by Keycloak not recognizing the certificate.</p>
        <p>To install the certificate into Keycloak, do the following:</p>
        <ol>
            <li>Run <code>datical-control truststore import --host &lt;AD server to connect to&gt; --port &lt;portnumber&gt;</code></li>
            <li>Run <code>datical-service stop keycloak</code></li>
            <li>Run <code>datical-service up -d keycloak</code></li>
            <li>Log in to Keycloak again to test the Bind DN/DN Credentials pair.</li>
        </ol>
        <ul>
            <li>
                <MadCap:xref href="../troubleshoot/troubleshoot-home.htm">Troubleshoot</MadCap:xref>
            </li>
        </ul>
    </body>
</html>